<!DOCTYPE html>
<html>
  <head>
    <script src="jquery.js"></script>
    <script src="jquery.timeago.js" type="text/javascript"></script>
    <script src="data_generator.js"></script>
    <style>
      body {
        background: #f0f0f0;
        font-family: Arial, sans-serif;
        font-size: 15px;
        color: #4d4d4d;
      }

      #outerwrap {
        width: 40%;
        max-width: 600px;
        min-width: 300px;
        margin: 20px auto;
      }

      h1 {
        font-family: Georgia, serif;
        font-size: 36px;
        font-weight: bold;
        color: #d5efcd;
        text-shadow: rgba(0, 0, 0, 0.6) -1px 0 10px;
      }

      #container {
        width: 100%;
        background-color: #fff;
        border-radius: 3px;
        box-shadow: 2px 2px 10px #999;
        border: solid #d7d7d7 1px;
      }

      article.tweet {
        border-bottom: solid #f0f0f0 1px;
        padding: 16px;
        font-size:17px;
      }

      article.tweet:last-child {
        border-bottom: none;
      }

      .username {
        display: block;
        margin-bottom: 4px;
        color: #d7d7d7;
      }

      .created-at {
        display: block;
        font-size: 10px;
        margin-top:3px;
      }

      #tweets-waiting {
        background-color: #d5efcd;
        text-align: center;
        cursor: pointer;
      }

      h1 a {
        text-decoration: none;
        color: #d5efcd;
      }
    </style>
  </head>
  <body>
    <div id="outerwrap">
      <h1><a href="index.html">tweetler</a></h1>
      <div id="container"></div>
    </div>
    <script>
    // userRefactor branch

    
    // URL Parser in case the user parameter is passed in
    var urlParams;
    (window.onpopstate = function () {
        var match,
            pl     = /\+/g,  // Regex for replacing addition symbol with a space
            search = /([^&=]+)=?([^&]*)/g,
            decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
            query  = window.location.search.substring(1);

        urlParams = {};
        while (match = search.exec(query))
           urlParams[decode(match[1])] = decode(match[2]);
    })();



      $(document).ready(function() {
       
        var $container = $('#container');
        $container.html('');
        var lengthHolder = streams.home.length -1;
        var messageActive;
        var index = streams.home.length - 1;

        
        // get the first whack from the bottom of the array on up
        var i = 0;
        while(i < index) {
          if(urlParams.user) {
            var tweet = streams.users[urlParams.user][i];
          } else {
            var tweet = streams.home[i];
          }

          var $tweet = $('<article class="tweet '+tweet.user+'" data-user="' + tweet.user + '"></article>');
          $tweet.prependTo($container).html('<a class="username" href="index.html?user='+tweet.user + '">@' + tweet.user + '</a><span class="message">' + tweet.message + '</span><abbr class="created-at" title="'+tweet.created_at.toISOString() + ' ">' + tweet.created_at + '</span>');
           i++;
           firstRun = false;
           $("abbr.created-at").timeago();
         }

         //okay, now let's do it regularly
          setInterval(function() {
              var tweetsWaiting = (streams.home.length-1) - lengthHolder;
              if((tweetsWaiting > 0) && (!messageActive)) {
                console.log(messageActive);
                $container.prepend('<article id="tweets-waiting" class="tweet">See the ' + tweetsWaiting + ' Tweets waiting for you!</article>');
                messageActive = true;
              } else if (messageActive) {
                $('#tweets-waiting').text('See the ' + tweetsWaiting + ' Tweets waiting for you!');
                $('#tweets-waiting').on('click', function(event) {
                  event.preventDefault();
                  $('#tweets-waiting').remove();
                  index = streams.home.length - 1;
                  while(lengthHolder < index) {
                    var tweet = streams.home[lengthHolder];
                    var $tweet = $('<article class="tweet"></article>');
                    $tweet.prependTo($container).html('<a class="username" href="index.html?user='+tweet.user + '">@' + tweet.user + '</a><span class="message">' + tweet.message + '</span><abbr class="created-at" title="'+tweet.created_at.toISOString() + ' ">' + tweet.created_at + '</span>');
                    lengthHolder++;
                    $("abbr.created-at").timeago();
                  }
                  messageActive = false;
                  lengthHolder = streams.home.length-1;
                })
              }
          }, 2000);
      });

      

    </script>
  </body>
</html>